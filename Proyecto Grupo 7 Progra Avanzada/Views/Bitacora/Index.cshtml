@model IEnumerable<Proyecto_Grupo_7_Progra_Avanzada.Models.Bitacora>

@{
    ViewData["Title"] = "Bitácora de Eventos";
}

<style>
    /* Estilos para que el JSON se vea bien */
    .json-box {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 5px;
        margin-top: 5px;
        overflow-x: auto;
        white-space: pre-wrap; /* Mantiene el formato JSON */
        font-size: 0.8rem;
        border-radius: 4px;
        max-height: 200px;
    }

    .event-error {
        background-color: #f8d7da; /* Fondo rojo suave para errores */
    }

    .btn-gold-outline {
        border: 1px solid #9f795d;
        color: #9f795d;
        background-color: transparent;
        border-radius: 4px;
        padding: 3px 8px;
        font-size: 0.8rem;
        cursor: pointer;
    }

        .btn-gold-outline:hover {
            background-color: #9f795d;
            color: white;
        }
</style>

<h2 class="page-title mb-4">Bitácora de eventos</h2>

<table class="table table-striped table-bordered align-middle custom-table">
    <thead class="table-dark">
        <tr>
            <th>Tabla</th>
            <th>Tipo</th>
            <th>Fecha</th>
            <th>Descripción</th>
            <th>StackTrace</th>
            <th>Datos Anteriores</th>
            <th>Datos Posteriores</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var evento in Model)
        {
            // Corregimos la propiedad:
            var isError = string.Equals(evento.TipoDeEvento, "Error", StringComparison.OrdinalIgnoreCase);

            <tr class="@(isError ? "event-error" : "")">
                <td>@(string.IsNullOrWhiteSpace(evento.TablaDeEvento) ? "-" : evento.TablaDeEvento)</td>

                <td>
                    @* Badge por tipo de evento *@
                    @{
                        var tipo = evento.TipoDeEvento?.Trim() ?? "-";
                        var badgeClass = tipo switch
                        {
                            "Crear" => "bg-success",
                            "Editar" => "bg-primary",
                            "Eliminar" => "bg-danger",
                            "Error" => "bg-danger",
                            _ => "bg-secondary"
                        };
                    }
                    <span class="badge @badgeClass">@tipo</span>
                </td>

                <td>@evento.FechaDeEvento.ToString("dd/MM/yyyy HH:mm")</td>

                <td>@(string.IsNullOrWhiteSpace(evento.DescripcionDeEvento) ? "-" : evento.DescripcionDeEvento)</td>

                <td>
                    @if (isError && !string.IsNullOrWhiteSpace(evento.StackTrace))
                    {
                        <div class="json-box">@evento.StackTrace</div>
                    }
                    else
                    {
                        <span class="text-muted">—</span>
                    }
                </td>

                @* Datos Anteriores *@
                <td>
                    <button type="button" class="btn-gold-outline mx-2" onclick="toggleJson(this)">Ver / Ocultar</button>
                    <pre class="json-box d-none"
                                      data-json='@Html.Raw((evento.DatosAnteriores ?? "").Replace("'", "&#39;"))'></pre>
                </td>

                @* Datos Posteriores *@
                <td>
                    <button type="button" class="btn-gold-outline mx-2" onclick="toggleJson(this)">Ver / Ocultar</button>
                    <pre class="json-box d-none"
                                      data-json='@Html.Raw((evento.DatosPosteriores ?? "").Replace("'", "&#39;"))'></pre>
                </td>
            </tr>
        }
    </tbody>
</table>

<script>
    // Formatea y muestra/oculta los JSON al presionar el botón
    function toggleJson(button) {
        const pre = button.nextElementSibling;
        if (pre.classList.contains("d-none")) {
            try {
                const raw = pre.dataset.json;
                if (!raw || raw.trim() === "") {
                    pre.textContent = "(sin datos)";
                } else {
                    const formatted = JSON.stringify(JSON.parse(raw), null, 2);
                    pre.textContent = formatted;
                }
            } catch {
                pre.textContent = pre.dataset.json || "(JSON inválido)";
            }
            pre.classList.remove("d-none");
            button.textContent = "Ocultar";
        } else {
            pre.classList.add("d-none");
            button.textContent = "Ver / Ocultar";
        }
    }
</script>