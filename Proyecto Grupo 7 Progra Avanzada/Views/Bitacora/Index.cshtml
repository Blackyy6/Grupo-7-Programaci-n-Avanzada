@model IEnumerable<Proyecto_Grupo_7_Progra_Avanzada.Models.Bitacora>

@{
    ViewData["Title"] = "Bitácora de Eventos";
}

<h2 class="mb-3">Bitácora de eventos</h2>

<style>
    .json-box {
        max-height: 200px;
        overflow: auto;
        background-color: #1e1e1e;
        color: #dcdcdc;
        font-family: Consolas, monospace;
        font-size: 0.85rem;
        padding: 8px;
        border-radius: 8px;
        white-space: pre-wrap;
        border: 1px solid #444;
    }

    .table thead th {
        text-align: center;
        vertical-align: middle;
    }

    .table td {
        vertical-align: top;
    }

    .toggle-btn {
        background-color: #0d6efd;
        color: white;
        border: none;
        padding: 4px 10px;
        border-radius: 5px;
        font-size: 0.8rem;
        cursor: pointer;
        margin-bottom: 5px;
    }
    .toggle-btn:hover {
        background-color: #0b5ed7;
    }

    /* 🔹 Resaltar filas de error */
    tr.event-error {
        background-color: #fff3f3;
    }
</style>

<table class="table table-striped table-bordered align-middle">
    <thead class="table-dark">
        <tr>
            <th>Tabla</th>
            <th>Tipo</th>
            <th>Fecha</th>
            <th>Descripción</th>
            <th>StackTrace</th>
            <th>Datos Anteriores</th>
            <th>Datos Posteriores</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var evento in Model)
        {
            var isError = string.Equals(evento.TipoDeEvento, "Error", StringComparison.OrdinalIgnoreCase);
            <tr class="@(isError ? "event-error" : "")">
                <td>@(string.IsNullOrWhiteSpace(evento.TablaDeEvento) ? "-" : evento.TablaDeEvento)</td>
                <td>
                    <!-- 🔹 Badge por tipo de evento -->
                    @{
                        var tipo = evento.TipoDeEvento?.Trim() ?? "-";
                        var badgeClass = tipo switch
                        {
                            "Crear" => "bg-success",
                            "Editar" => "bg-primary",
                            "Eliminar" => "bg-danger",
                            "Error" => "bg-danger",
                            _ => "bg-secondary"
                        };
                    }
                    <span class="badge @badgeClass">@tipo</span>
                </td>
                <td>@evento.FechaDeEvento.ToString("dd/MM/yyyy HH:mm")</td>
                <td>@(string.IsNullOrWhiteSpace(evento.DescripcionDeEvento) ? "-" : evento.DescripcionDeEvento)</td>
                <td>
                    <!-- 🔹 Mostrar StackTrace solo si hay contenido y es Error -->
                    @if (isError && !string.IsNullOrWhiteSpace(evento.StackTrace))
                    {
                        <div class="json-box">@evento.StackTrace</div>
                    }
                    else
                    {
                        <span class="text-muted">—</span>
                    }
                </td>

                <!-- 🔹 DATOS ANTERIORES -->
                <td>
                    <button type="button" class="toggle-btn" onclick="toggleJson(this)">Ver / Ocultar</button>
                    <pre class="json-box d-none"
                         data-json='@Html.Raw((evento.DatosAnteriores ?? "").Replace("'", "&#39;"))'></pre>
                </td>

                <!-- 🔹 DATOS POSTERIORES -->
                <td>
                    <button type="button" class="toggle-btn" onclick="toggleJson(this)">Ver / Ocultar</button>
                    <pre class="json-box d-none"
                         data-json='@Html.Raw((evento.DatosPosteriores ?? "").Replace("'", "&#39;"))'></pre>
                </td>
            </tr>
        }
    </tbody>
</table>

<script>
    // Formatea y muestra/oculta los JSON al presionar el botón
    function toggleJson(button) {
        const pre = button.nextElementSibling;
        if (pre.classList.contains("d-none")) {
            try {
                const raw = pre.dataset.json;
                if (!raw || raw.trim() === "") {
                    pre.textContent = "(sin datos)";
                } else {
                    const formatted = JSON.stringify(JSON.parse(raw), null, 2);
                    pre.textContent = formatted;
                }
            } catch {
                pre.textContent = pre.dataset.json || "(sin datos)";
            }
            pre.classList.remove("d-none");
            button.textContent = "Ocultar";
        } else {
            pre.classList.add("d-none");
            button.textContent = "Ver / Ocultar";
        }
    }
</script>